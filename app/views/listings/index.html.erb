<% content_for :head do %>
    <head>
      <style>
        body {
          overflow-x: hidden;
        }

        #map-canvas {
          position: relative;
          height: 88%;
          width: 64%;
        }

        #container {
          margin: 0px;
          padding: 0px;
          height: 88%;
        }

        #header {
          height: 5%;
          width: 100%;
          left: 10px;
        }

        #footer {
          position: absolute;
          left: 10px;
          bottom: 0;
          height: 5%;
          width: 100%;
          overflow:hidden;
        }
        ul {
          list-style-type: none;
          width: 98%;
          padding-left: 4px;
          padding-right: 3px;
          padding-top: 3px;
          margin: 0px;
        }

        #price {
          font-size: 33px;
          letter-spacing: .81px;
          font-family: Helvetica Neue,Helvetica,Arial,sans-serif;
          -webkit-font-smoothing: antialiased;
          font-weight: 300;
          border-bottom: 1px solid #f1f1f4;
          padding-bottom: 10px;
          padding-top: 10px;
        }

        li img {
          float: left;
          margin: 0 0 0 0;
        }

        #listing-text1 {
          font-size: 16px;
          letter-spacing: .1px;
          font-family: Helvetica Neue,Helvetica,Arial,sans-serif;
          -webkit-font-smoothing: antialiased;
          font-weight: 310;
          padding-top: 8px;
          padding-bottom: 3px;
        }

        #listing-text2 {
          font-size: 14px;
          letter-spacing: .1px;
          font-family: Helvetica Neue,Helvetica,Arial,sans-serif;
          -webkit-font-smoothing: antialiased;
          font-weight: 310;
          padding-top: 5px;
          padding-bottom: 1px;
        }

        li {
          overflow: auto;
          margin-bottom: 10px;
          background-color: #FFF;
          border: 1px solid #e6e6e6;
          padding: 5px
        }

        li:hover {
          outline: -webkit-focus-ring-color auto 3px;
          cursor: pointer;
        }
      </style>

      <!-- load google maps from google -->
      <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=geometry,places&ext=.js"></script>

      <!-- load jquery from jquery cdn -->
      <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous">
      </script>

      <!-- load handlebars.js from cdn, this is used for js templating-->
      <script
      src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.js">
      </script>

      <script type='text/javascript'>//<![CDATA[

      var geocoder;
      var map;
      var markers = []; // array of markers

      var activeNow;

      // initialize orange marker image
      var orangePinColor = "FF4500";
      var orangePinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + orangePinColor,
          new google.maps.Size(21, 34),
          new google.maps.Point(0, 0),
          new google.maps.Point(10, 34));

      // initialize yellow marker image
      var yellowPinColor = "ffff00";
      var yellowPinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + yellowPinColor,
          new google.maps.Size(21, 34),
          new google.maps.Point(0, 0),
          new google.maps.Point(10, 34));

      var properties = new Array();

      function initialize() {
          $.getJSON('/listings/show', function(json){
              // creating deep copy of returned jsonq
              properties = JSON.parse(JSON.stringify(json));

              var template = $('#properties-listing').html();
              var context = {
                  data : properties
              }
              Handlebars.registerHelper("inc", function(value, options)
              {
                  return parseInt(value) + 1;
              });

              map = new google.maps.Map(document.getElementById('map-canvas'), {
                  mapTypeId: google.maps.MapTypeId.ROADMAP
              });

              // markers will be shown on map for these coordinates
              var bounds = new google.maps.LatLngBounds();

              var templateScript = Handlebars.compile(template);
              var html = templateScript(context);

              $('#property-list ul').append(html);


              properties.forEach(function(property, index) {
                  // to begin with all markers will be in orange color
                  var marker = new google.maps.Marker({
                      position: new google.maps.LatLng(properties[index].latitude, properties[index].longitude),
                      map: map,
                      icon: orangePinImage
                  });
                  // markers will have id corresponding to their position in markers array
                  marker.set("id", index+1);

                  // when mouse is over a marker it will turn yellow
                  google.maps.event.addListener(marker, 'mouseover', function() {
                      marker.setIcon(yellowPinImage);
                  });

                  //when the mouse goes out of the marker, it will turn orange if it is not a marker which was clicked on (activeNow)
                  google.maps.event.addListener(marker, 'mouseout', function() {
                      if (marker.get("id")!=activeNow) {
                          marker.setIcon(orangePinImage);
                      }
                  });

                  // when a marker is clicked the corresponding property in the list will be scrolled to and marked with a blue border
                  google.maps.event.addListener(marker, 'click', function() {
                      // inactivate the property and marker activated before the current marker was clicked
                      if (typeof activeNow != 'undefined') {
                          markers[activeNow-1].setIcon(orangePinImage);
                          $('#property-list li:nth-child('+markers[activeNow-1].get("id")+')').css('outline','');
                      }
                      // scroll to property corresponding to the marker (use jquery for animation)
                      $('#property-list').animate({
                          scrollTop: $('#property-list li:nth-child('+marker.get("id")+')').position().top - $('#property-list li:first').position().top
                      }, 'slow');

                      // add blue border
                      var idm = marker.get("id");
                      $('#property-list li:nth-child('+idm+')').css('outline','-webkit-focus-ring-color auto 3px');

                      activeNow = marker.get("id");
                  });

                  markers.push(marker);
                  bounds.extend(marker.position);
              });
              // position the map so that all markers are visible
              map.fitBounds(bounds);
          });
      }

      // call initialize method to load map on window load
      google.maps.event.addDomListener(window, "load", initialize);

      // called when mouse goes on or out of a property in the property list
      showme = function (index) {

          // inactivate the property and marker activated before the current marker was clicked
          if (typeof activeNow != 'undefined') {
              markers[activeNow-1].setIcon(orangePinImage);
              $('#property-list li:nth-child('+markers[activeNow-1].get("id")+')').css('outline','');
          }

          if (markers[index].getAnimation() != google.maps.Animation.BOUNCE) {
              // make marker bounce
              markers[index].setAnimation(google.maps.Animation.BOUNCE);
              // make marker turn yellow
              markers[index].setIcon(yellowPinImage);
          } else {
              // make marker orange
              markers[index].setIcon(orangePinImage);
              // stop bouncing
              markers[index].setAnimation(null);
          }
      }
      //]]>

      </script>
    </head>
<% end %>

<body>
<div class="container" style="position: relative;">
  <div id="header">
    header
  </div>
  <div id="map-canvas" style="float:left;">
  </div>


  <script id ="properties-listing" type="text/x-handlebars-template">
    {{#each data}}
    <li onmouseover="javascript:showme({{@index}});" onmouseout="javascript:showme({{@index}});">
      <img class="someClass" src="{{images[0]}}"
           width = "200" height="130" style="padding: 0 10px 10px 0" />
      <div id="price">${{price}}</div>
      <div id="listing-text1">{{streetname}}</div>
      <div id="listing-text2">{{city}}</div>
    </li>
    {{/each}}
  </script>

  <div id="property-list" style="float:right; width:35%; margin-left: 3px; overflow-y: scroll; max-height: 88%; overflow-x: hidden">
    <ul>


    </ul>
  </div>
</div>
<div id="footer">
  footer
</div>
</body>